package com.example.registration.service;

import java.io.UnsupportedEncodingException;
import java.util.List;

import javax.mail.MessagingException;
import javax.mail.internet.MimeMessage;
import javax.transaction.Transactional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Service;

import com.example.registration.model.Invoice;
import com.example.registration.model.RechargePlan;
import com.example.registration.model.User;
import com.example.registration.repository.InvoiceRepository;
import com.example.registration.repository.RechargePlanRepository;
import com.example.registration.repository.RegisterationRepository;

@Service
@org.springframework.transaction.annotation.Transactional
public class RegistrationService {
	
	@Autowired
	private JavaMailSender mailSender;
		
	@Autowired
	private RegisterationRepository repo;
	
	@Autowired
	private RechargePlanRepository planRepo;
	
	@Autowired
	private InvoiceRepository invoiceRepo;
	
	public User saveUser(User user) 
	{
		return repo.save(user);
	}
	
	public RechargePlan savePlan(RechargePlan plan) {
		return planRepo.save(plan);
	}
	
	public Invoice saveInvoice(Invoice invoice) {
		return invoiceRepo.save(invoice);
	}
	
	public void sendVerificationEmail(User user, String siteURL) throws UnsupportedEncodingException, MessagingException 
	{
		String subject="Verify your registration to VoizFonica Telecom";
		String senderName="VoizFonica Telecom";
		String mailContent = "<p>Dear "+user.getFullname()+"</p>";
		
		mailContent+="<p>Greetings from VoizFonica Telecom.<br>Please click on the link below to verify your account.</p>";
		
		String verifyURL=siteURL+"/verification?code="+user.getVerificationCode();
		
		mailContent+="<h3><a href=\""+ verifyURL +"\">Verify Now!</a></h3>";
		mailContent+="<p>Thanks and Regards,<br>VoizFonica Telecom<br><em>Team-A@Prodapt-Digital-21</em></p>";
		
		MimeMessage message=mailSender.createMimeMessage();
		MimeMessageHelper helper=new MimeMessageHelper(message);
		
		helper.setFrom("eng18cs0097.ebinjacob@gmail.com", senderName);
		helper.setTo(user.getEmailid());
		helper.setSubject(subject);
		helper.setText(mailContent,true);
		
		mailSender.send(message);
	}
	public boolean verify(String verificationCode) 
	{
		User user=repo.findByVerificationCode(verificationCode);
		if(user==null || user.isEnabled()) 
		{
			return false;
		}
		else 
		{
			repo.enable(user.getEmailid());
			return true;
		}
	}
	
	public User fetchUserByEmailid(String email) 
	{
		return repo.findByEmailid(email);
	}
	public User fetchUserByEmailidAndPassword(String email, String password) 
	{
		return repo.findByEmailidAndPassword(email, password);
	}
	public User fetchUserById(int id) {
		return repo.findById(id);
	}
	public RechargePlan fetchRechargePlanById(int id) {
		return planRepo.findbyId(id);
	}
	public List<Invoice> fetchInvoiceByUserId(int userId) {
		return invoiceRepo.findbyUserId(userId);
	}
	public List<RechargePlan> fetchRechargePlanByServiceType(String serviceType) {
		return planRepo.findByServiceType(serviceType);
	}
}
