package com.example.registration.controller;

import java.time.LocalDate;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

import com.example.registration.model.Invoice;
import com.example.registration.model.RechargePlan;
import com.example.registration.service.InvoiceGenerationService;
import com.example.registration.service.RechargeService;
import com.example.registration.service.RegistrationService;

@RestController
@CrossOrigin(origins = "http://localhost:4200")
public class InvoiceController {
	
	@Autowired
	private InvoiceGenerationService invoiceService;
	
	@Autowired
	private RechargeService rechargeService;
	
	@Autowired
	private RegistrationService userService;
	
	@PostMapping("/recharge")
	public Invoice rechargeAccount(@RequestBody int planId, int userId) throws Exception {
		Invoice invoice = new Invoice();
		Optional<RechargePlan> plan = new RechargePlan();
		plan = rechargeService.fetchRechargePlanByPlanId(planId);
		userService.setCurrentPlan(userId, planId);
		invoice.setPlanId(planId);
		invoice.setUserId(userId);
		LocalDate currentDate = java.time.LocalDate.now();
		String dateInput = currentDate.toString();
		invoice.setRechargeDate(dateInput);
		invoice.setRechargeAmount(plan.getPlanCost());
		Invoice invoiceObj = new Invoice();
		invoiceObj = null;
		invoiceObj = invoiceService.saveInvoice(invoice);
		if(invoiceObj==null) {
			throw new Exception("Recharge could not be completed. Please try again!");
		}
		return invoiceObj;
	}
	
	@PostMapping("/my_invoices")
	public List<Invoice> getUserInvoices(@RequestBody int UserId) throws Exception{
		List<Invoice> resp = invoiceService.fetchInvoiceByUserId(UserId);
		if(resp==null) {
			throw new Exception("No invoices");
		}
		return resp;
	}
}
